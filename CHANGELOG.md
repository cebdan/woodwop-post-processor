# Отчет об изменениях WoodWOP Post Processor

## Версия: Обновленная логика создания файлов и определения имен

### Дата: 2024

---

## Основные изменения

### 1. Исправлена логика создания файлов

**Проблема:**
- FreeCAD создавал файл `.nc` до вызова `export()`
- Post-processor записывал оба файла (`.mpr` и `.nc`) самостоятельно
- Возвращалась пустая строка
- FreeCAD перезаписывал `.nc` файл пустым содержимым

**Решение:**
- Post-processor создает `.mpr` файл с правильным содержимым
- Post-processor создает `.nc` файл с G-code содержимым
- Возвращается G-code содержимое для FreeCAD, чтобы он записал его в `.nc` файл
- Оба файла создаются с одинаковым базовым именем

**Результат:**
- Оба файла (`.mpr` и `.nc`) создаются корректно
- FreeCAD не перезаписывает файлы пустым содержимым
- Файлы имеют правильное содержимое

---

### 2. Улучшена логика определения базового имени файла

**Проблема:**
- Имя файла определялось из диалога FreeCAD
- Не использовались настройки Job (Model, part name)

**Решение:**
Реализована система приоритетов для определения базового имени:

1. **PostProcessorOutputFile с полным путем** (если указан путь)
2. **Model из Job** (переменная "модел" или "Model")
3. **Part name** (имя детали из Job.Base)
4. **PostProcessorOutputFile только с именем** (fallback)
5. **Имя из диалога FreeCAD** (последний fallback)
6. **"export"** (значение по умолчанию)

**Особенности:**
- Автоматический поиск свойства Model в Job (проверяются варианты: Model, ModelName, модел)
- Поиск по PropertiesList для свойств, содержащих "model" или "модел"
- Извлечение имени детали из Job.Base (поддержка одиночных объектов и групп)
- Подробная отладочная информация для диагностики

**Результат:**
- Файлы создаются с именем из Model или part name
- Имя из диалога игнорируется, если есть более приоритетные источники
- Добавлена отладочная информация для отслеживания источника имени

---

### 3. Исправлена логика определения директории для файлов

**Проблема:**
- Если `PostProcessorOutputFile` содержал только имя файла без пути (например, "ert")
- `os.path.dirname("ert")` возвращал пустую строку
- `os.path.abspath("ert")` в корневой директории давал "/"
- Попытка записать файл в "/ert.mpr" приводила к ошибке "Read-only file system"

**Решение:**
- Проверка наличия пути в `PostProcessorOutputFile`
- Если путь отсутствует, используется директория документа FreeCAD
- Защита от использования корневой директории "/"
- Приоритет определения директории:
  1. Из `PostProcessorOutputFile` (если содержит путь)
  2. Из директории документа FreeCAD
  3. Текущая рабочая директория (fallback)

**Результат:**
- Файлы создаются в правильной директории
- Нет ошибок при записи в корневую директорию
- Работает даже если `PostProcessorOutputFile` содержит только имя файла

---

### 4. Игнорирование диалога сохранения FreeCAD

**Проблема:**
- FreeCAD показывает диалог сохранения перед вызовом `export()`
- Имя из диалога использовалось для определения имени файла

**Решение:**
- Полностью игнорируется `filename` из диалога для определения имени файла
- Директория определяется только из Job settings или директории документа
- Имя файла определяется только из Model или part name
- Добавлены комментарии, объясняющие, что диалог игнорируется

**Результат:**
- Файлы создаются автоматически на основе Model или part name
- Не зависит от того, что пользователь вводит в диалоге
- Диалог может показываться, но его содержимое игнорируется

---

### 5. Добавлено создание отчета о свойствах Job

**Новая функциональность:**
- Создается файл отчета `{base_filename}_job_report.txt`
- Отчет содержит все свойства Job объекта
- Структурированный формат с разделителями

**Содержимое отчета:**
- Основная информация (Label, Name, TypeId)
- Все свойства Job с их значениями
- Специальные свойства (PostProcessorOutputFile, Model, Base, Stock, Operations и др.)
- Информация о Stock (если доступна)

**Результат:**
- Помогает диагностировать проблемы с определением имени файла
- Показывает все доступные свойства Job
- Упрощает отладку и настройку

---

## Технические детали

### Измененные функции

1. **`export()`** - основная функция экспорта
   - Добавлена логика определения базового имени с приоритетами
   - Улучшена логика определения директории
   - Добавлено создание отчета о свойствах Job
   - Игнорирование `filename` из диалога

2. **`create_job_report()`** - новая функция
   - Создает подробный отчет о всех свойствах Job
   - Форматирует значения в зависимости от типа
   - Обрабатывает специальные типы FreeCAD (Value, Unit, Label)

### Добавленная отладочная информация

- Логирование всех найденных значений (job_output_file, job_model, part_name)
- Отслеживание приоритета, использованного для определения имени
- Вывод всех свойств Job, если Model не найдена автоматически
- Информация об игнорировании имени из диалога

---

## Использование

### Определение имени файла

1. Установите переменную **Model** в Job (или используйте имя детали)
2. Post-processor автоматически создаст файлы с этим именем
3. Диалог FreeCAD может показываться, но его содержимое игнорируется

### Создаваемые файлы

- `{имя}.mpr` - WoodWOP MPR файл
- `{имя}.nc` - G-code файл
- `{имя}_job_report.txt` - Отчет о свойствах Job

### Отладка

Если имя файла определяется неправильно:
1. Проверьте отчет `{имя}_job_report.txt`
2. Найдите свойство Model в отчете
3. Проверьте логи FreeCAD для отладочной информации
4. Убедитесь, что Model установлена в Job

---

## Известные ограничения

1. **Диалог FreeCAD:** Диалог сохранения может показываться на уровне FreeCAD UI (до вызова `export()`). Мы не можем полностью отключить его из post-processor, но полностью игнорируем его содержимое.

2. **Модуль woodwop_gcode_post:** Если модуль `woodwop_gcode_post` не найден, используется упрощенная генерация G-code.

---

## Будущие улучшения

- Возможность настройки приоритетов через аргументы командной строки
- Поддержка дополнительных источников имени файла
- Улучшенная обработка ошибок
- Оптимизация производительности

---

## Заключение

Все основные проблемы с созданием файлов и определением имен решены. Post-processor теперь:
- Создает оба файла (`.mpr` и `.nc`) корректно
- Использует имя из Model или part name вместо имени из диалога
- Создает файлы в правильной директории
- Предоставляет подробную отладочную информацию
- Создает отчет о свойствах Job для диагностики

